<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar Sesi√≥n - Psic√≥logo</title>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="styles_registr.css">
</head>
<body>

  <div class="form-container">
    <h2>Iniciar Sesi√≥n</h2>

    <input id="emailLogin" type="email" placeholder="Correo electr√≥nico" required>
    
    <div class="password-container">
      <input id="passwordLogin" type="password" placeholder="Contrase√±a" required>
      <span id="togglePasswordLogin" class="eye-icon" style="cursor: pointer;">üëÅÔ∏è</span>
    </div>

    <p id="loginError" class="mensaje-error" style="display: none; color: red; font-weight: bold;"></p>
    <p id="loginExito" class="mensaje-exito" style="display: none; color: green; font-weight: bold;">‚úÖ Redirigiendo...</p>

    <button id="loginBtn">Entrar</button>

    <p class="extra-link">
      ¬øNo tienes cuenta? <a href="registro_p.html">Reg√≠strate aqu√≠</a>
    </p>
    <p class="extra-link">
      ¬øOlvidaste tu contrase√±a? <a href="recuperar_contrase√±a.html">Recupera aqu√≠</a>
    </p>
  </div>

 <script>
    // 1. CONFIGURACI√ìN
    const firebaseConfig = {
        apiKey: "AIzaSyCq2lQnID4SSkFIKh_ja6paB4aHuq4KU0M",
        authDomain: "proyectercerparcial.firebaseapp.com",
        databaseURL: "https://proyectercerparcial-default-rtdb.firebaseio.com",
        projectId: "proyectercerparcial",
        storageBucket: "proyectercerparcial.appspot.com",
        messagingSenderId: "39792129165",
        appId: "1:39792129165:web:631ce9e0c7fb657a135ec4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. ELEMENTOS DEL DOM
    const emailInput = document.getElementById('emailLogin');
    const passwordInput = document.getElementById('passwordLogin');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const loginExito = document.getElementById('loginExito');

    // 3. MOSTRAR/OCULTAR CONTRASE√ëA
    document.getElementById('togglePasswordLogin').addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
    });

    // 4. L√ìGICA DE LOGIN CON VALIDACI√ìN DE ESTADO
    loginBtn.addEventListener('click', function() {
        const email = emailInput.value;
        const password = passwordInput.value;

        // Limpiar mensajes
        loginError.style.display = 'none';
        loginExito.style.display = 'none';

        if (!email || !password) {
            loginError.textContent = 'Por favor, completa todos los campos';
            loginError.style.display = 'block';
            return;
        }

        // Bloquear bot√≥n
        loginBtn.textContent = 'Verificando...';
        loginBtn.disabled = true;

        // PASO A: Autenticar (Email/Pass correctos)
        auth.signInWithEmailAndPassword(email, password)
            .then(async (userCredential) => {
                const user = userCredential.user;

                // PASO B: Consultar Base de Datos para ver el estado
                // NOTA: Aseg√∫rate que tu colecci√≥n se llame 'psicologos' (min√∫scula o may√∫scula seg√∫n tu BD)
                const doc = await db.collection('psicologos').doc(user.uid).get();

                if (!doc.exists) {
                    throw new Error("NO_REGISTRO");
                }

                const datos = doc.data();
                const estado = datos.estado; // puede ser 'aprobado', 'pendiente', etc.

                console.log("Estado del usuario:", estado); // Para depurar

                // PASO C: Validar Estado
                if (estado === 'aprobado') {
                    // ‚úÖ APROBADO
                    loginExito.textContent = '‚úÖ Acceso autorizado. Redirigiendo...';
                    loginExito.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '../nav-alice-psicologo/perfilPsic.html';
                    }, 1500);
                } else if (estado === 'pendiente') {
                    // ‚è≥ PENDIENTE
                    throw new Error("PENDIENTE");
                } else {
                    // üö´ CUALQUIER OTRA COSA (rechazado, baja, etc)
                    throw new Error("NO_AUTORIZADO");
                }
            })
            .catch((error) => {
                // Si entr√≥ al catch, significa que la contrase√±a estaba mal 
                // O que nosotros lanzamos un error (PENDIENTE/NO_AUTORIZADO)
                
                // Si el usuario lleg√≥ a loguearse pero no estaba aprobado, cerramos su sesi√≥n
                if (auth.currentUser) {
                    auth.signOut();
                }

                let msg = 'Error al iniciar sesi√≥n';
                
                if (error.message === 'PENDIENTE') {
                    msg = '‚è≥ Tu cuenta est√° en revisi√≥n. Espera a ser aprobado.';
                } else if (error.message === 'NO_AUTORIZADO') {
                    msg = 'üö´ Tu cuenta no tiene permisos para acceder o ha sido dada de baja.';
                } else if (error.message === 'NO_REGISTRO') {
                    msg = '‚ö†Ô∏è No se encontraron datos de perfil para este usuario.';
                } else {
                    // Errores est√°ndar de Firebase
                    switch (error.code) {
                        case 'auth/user-not-found': msg = 'Usuario no encontrado'; break;
                        case 'auth/wrong-password': msg = 'Contrase√±a incorrecta'; break;
                        case 'auth/invalid-email': msg = 'Email inv√°lido'; break;
                        case 'auth/too-many-requests': msg = 'Demasiados intentos'; break;
                        default: msg = error.message;
                    }
                }
                
                loginError.textContent = msg;
                loginError.style.display = 'block';
                
                // Restaurar bot√≥n
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;
            });
    });

    // Enter para enviar
    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') loginBtn.click();
    });
</script>
</body>
</html>